# Chapter 11: Working with Systemd

**Systemd**
- system and service manager for linux
- first process that runs when the computer starts
- uses 'systemctl' command name
- starts system, manages services, controls system state, logs and tracks services
- manages "units", which can be a variety of things, one of the main ones being services

`systemctl -t help` lists all available units.

Unit files can be in 3 places:
1. */etc/systemd/system* - has custom unit files and files that may be written by an admin or generated by "systemctl edit" command
2. */usr/lib/systemd/system* - has default unit files that were installed by RPM packages. **Never edit these files directly.**
3. */run/systemd/system* - has automatically generated unit files 

**The recommended way to edit unit files in /etc/systemd/system is to use `systemctl edit unit-name`.** The command creates a subdirectory in that path for the service being edited. A file *override.conf* is created where it overwrites everything in the original file, such as settings.

Most important unit type is the **service unit** which is used to start/manage processes.

Components of a service unit file: 

- **[Unit]**: describes unit and defines dependencies
  - *After*: indicates the unit should be startes after a specified unit
  - *Before*: indicates this unit should be started before a specified unit (optional)

- **[Service]**: describes how to stat and stop the service and request status installation
  - usually has an 'ExecStart' or 'ExecStop' line to show how to start/stop
  - Type: specifies how a process should start
    - forking type: commonly used by daemon processes
    - oneshot type: start any command from a systemd unit 
    - simple: same as above

- **[Install]**: indicates which target this unit must be started in 
  - optional, but can't be started automatically without it

**Mount unit** specifies how a file system can be mounted on a specific directory. Alternative for mounting file systems through */etc/fstab*.

Components of a mount unit file:

- **[Unit]**: descries and defines dependencies
  - Conflicts: lists units that can't be used together with this unit. Used for mutually exclusive units.

- **[Mount]**: defines exactly where the mount has to be performed
  - has arguments typically used in `mount` commands.

**Socket unit**
- sockets create a method for applications to communicate with each other
- they are a communication endpoint
- when you visit a site, your browser connects to a socket on the web server, typically port 80 for HTTP or port 443 for HTTPS
- socket units manage these communication points for servicecs
- can be a file or port which Systemd is listening to
  - service only starts if a connection comes to the specified socket
- every socket needs a corresponding service file

Components of a socket unit file:

**[Socket]**
  - *ListenStream*: defines the TCP port that Systemd should be listening to for incoming connections
  - *ListenDatagram*: defines the UDP port that Systemd should be listening to for incoming connections

**Target unit**
- a group of units/services
- targets are "milestones" or "checkpoints" in setting up or shutting down your computer
- it tells the unit files when they need to run or be loaded
- targets can have dependencies on other targets, which arfe defined in the target unit file
- the target unit file describes its requirements and what it can't coexist with
  - it uses *After* for load ordering, specifying when it needs to load the target unit
  - does not list the units that are included. Each unit that belongs to the target should be listed in the [Install] section of their own unit file
- when you add a unit to a target, it creates a symbolic link in the target directory in */etc/systemd/system*
  - this link is considered a *Want* as it defines what the target wants to start when it is processed

`systemctl`
- primary command to manage systemd units
- start, stop, restart, enable, disable and view the status of services and other units
- used for system management tasks

**`systemctl` unit commands**

`systemctl -t service` shows service units.

`systemctl list-units -t service` shows all active service units. Similar to previous command.

`systemctl list-units -t service --all` shows both active and inactive service units.

`systemctl --failed -t service` shows failed services.

`system status -l your.service` shouws detailed info about a service.

2 ways to manage systemd dependencies:

1. Unit types have a corresponding service unit and Systemd understand it.For instance, cockpit.socket and cockpit.service are corresponding files. Accessing either one will trigger the service type.

2. Dependencies can be defined in the unit with keywords like *Requires, Requisite, Before, After*.

`systemctl list-dependencies unit-name` lists dependencies of a specified unit.

`systemctl list-dependencies --reverse unit-name` lists units that depend on the specified unit.

**Dependency keywords in [Unit]**

- **Requires**: if this unit loads, the units listed here will also load. If a unit here is deactivated, this unit will also be deactivated.

- **Requisite**: if the units listed here isn't already loaded, this unit will fail

- **Wants**: the unit wants to load the units which are listed here, but it won't fail if the listed units fail

- **Before**: the unit will start before the units listed here

- **After**: the unit will start after the units listed here

`systemctl show unit-name` lists available options for a specific unit.


### Do you already know? Questions

1. To show all service unit files on the system which are currently loaded, use `systemctl -t service`.

2. Systemd "wants" are system specific and managed through */etc/systemd/system*.

3. To avoid conflicts between incompatible units, you should mask it. This makes it impossible to enable.

4. Active (Running), Active (Exited), and Active (Waiting) are all valid statuses for Systemd.

5. Socket units monitor socket activity, which includes a file being accessed or network port being accessed. They do not monitor PATH activity, that is done by path unit types. 

6. Service, mount and socket are valid Systemd unit types.

7. To find out which Systemd units have dependencies to a specific unit, use `systemctl list-dependencies --reverse`.

8. To change the default editor of Systemd to vim, add this: `export SYSTEMD_EDITOR="/bin/vim"` to the *~/.bashrc* file.

9. To define a Systemd dependency that ensures the boot precedure doesn't fail if the dependency fails, use the keyword **Wants**. It defines a unit is "wanted" without setting a hard requirement.

10. When working with units in systemctl, it's always the last word of the command. *Ex:* `systemctl start unit`.


### Review Questions

1. A **unit** is something that is started by Systemd. Types of units include service, mount, socket, etc.

2. To show all service units that are currently loaded, use `systemctl list-units`.

3. To create a want, use `systemctl enable service-name`. This means that it gets automatically started when the system boots. 

4. To change the default editor for systemctl, add `export SYSTEMD_EDITOR="/bin/vim"` in the *~/.bashrc* file. This is user-specific. To set the default editor to vim for all users, add this `SYSTEMD_EDITOR="/bin/vim"` in /etc/environment file.

5. */etc/systemd/system* contains custom Systemd unit files.

6. To ensure a unit file will automatically load another unit file, include the **Requires** keyword in the unit file.

7. To show available config options for httpd.service, use `systemctl show httpd`.

8. To list dependencies of a specific unit, use `systemctl list-dependencies --reverse unit-name`, which shows all units depend on the specified unit.

9. A systemctl status that is *dead* means that the service is not running.

10. To create a Systemd override file, use `systemctl edit unit-name`.
